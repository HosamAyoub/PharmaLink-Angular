<!-- add-medicines.component.html -->
<div class="add-medicines-container">
  <!-- Header -->
  <div class="header">
    <button class="back-button" routerLink="/pharmacy/medicinemanagement">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
        <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.42-1.41L7.83 13H20v-2z" />
      </svg>
      Back to Medicines
    </button>
    <div class="header-content">
      <h1>Add Medicines</h1>
      <p>Search and add medicines to your inventory</p>
    </div>
  </div>

  <!-- Search Section -->
  <div class="search-section">
    <div class="search-header">
      <svg class="search-icon" width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
        <path
          d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z" />
      </svg>
      <h2>Search Medicines Database</h2>
    </div>
    <p class="search-description">Find medicines from our verified database and add them to your inventory</p>

    <div class="search-input-container">
      <div class="search-input-wrapper">
        <svg class="input-search-icon" width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
          <path
            d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z" />
        </svg>
        <input type="search" #searchInput (input)="onSearchChange(searchInput.value)"
          placeholder="Search by medicine name or category or active ingredient..." class="search-input">
      </div>
      <button class="medicine-not-listed-btn" data-bs-toggle="modal" data-bs-target="#requestAdminModal">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
          <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z" />
        </svg>
        Medicine Not Listed?
      </button>
    </div>
  </div>

  <!-- Selected Medicines Section -->
  @if (selectedMedicines.length > 0) {
  <div class="selected-medicines-section">
    <div class="selected-medicines-header">
      <div class="selected-medicines-title">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
          <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z" />
        </svg>
        Selected Medicines
        <span class="selected-count">{{ selectedMedicines.length }} selected</span>
      </div>
      <button class="AddStock-button" data-bs-toggle="modal" data-bs-target="#addStockModal">
        Add To Stock
      </button>
    </div>
    <div class="selected-medicines-list">
      @for (medicine of selectedMedicines; track medicine.drugdetails.drugID) {
      <div class="selected-medicine-tag">
        {{ medicine.drugdetails.commonName }}
        <button class="remove-tag" (click)="removeMedicine(medicine)">
          <i class="remove-icon">&times;</i>
        </button>
      </div>
      }
    </div>
  </div>
  }

  <!-- Medicine Cards Grid -->
  <div class="medicines-grid">
    @for (medicine of filteredMedicines; track medicine.drugID) {
    <div class="medicine-card m-0 " [class.selected]="checkSelectedMedicine(medicine)===2"
      (click)="onMedicineClick(medicine)">
      <div class="medicine-card-content m-0 ">
        <div class="medicine-icon">
          <img [src]="medicine.drug_UrlImg" alt="{{ medicine.commonName }}" class="medicine-image">
        </div>
        <div class="medicine-info">
          <h3 class="medicine-name">{{ medicine.commonName }}</h3>
          <p class="medicine-ingredient">{{ medicine.activeIngredient }}</p>
          <p class="medicine-category">{{ medicine.category }}</p>
        </div>
        <div class="alert alert-success mt-auto" style="width:6rem; padding: 0.5rem; text-align: center;"
          *ngIf="checkSelectedMedicine(medicine) === 1">
          In Stock
        </div>
      </div>
      <div id="checkbox{{ medicine.drugID }}" class="selection-checkbox">
        <div class="checkbox" [class.checked]="checkSelectedMedicine(medicine) === 2">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="white" *ngIf="checkSelectedMedicine(medicine)===2">
            <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z" />
          </svg>
        </div>
      </div>
    </div>
    }
  </div>

  <!-- Add Medicine Details Modal -->
  <div class="modal fade" id="addStockModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="addStockModalLabel">Add Selected Medicines to Stock</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          @if (selectedMedicines.length === 0) {
          <div class="text-center text-muted py-4">
            No medicines selected.
          </div>
          }
          @if (selectedMedicines.length > 0) {
          <div class="table-responsive">
            <table class="table table-bordered align-middle">
              <thead class=" text-white">
                <tr style="justify-content: center; align-items: center;">
                  <th style="width: 8px;">Image</th>
                  <th style="width: 40px;">Name</th>
                  <th style="width: 40px;">Category</th>
                  <th style="width: 50px;">Quantity</th>
                  <th style="width: 5px;">Price</th>
                </tr>
              </thead>
              <tbody>
                @for (medicine of selectedMedicines; track medicine.drugdetails.drugID) {
                <tr style="justify-content: center; align-items: center;">
                  <td>
                    <img [src]="medicine.drugdetails.drug_UrlImg" alt="{{ medicine.drugdetails.commonName }}"
                      style="height: 80px; object-fit: contain; border-radius: 6px;">
                  </td>
                  <td>{{ medicine.drugdetails.commonName }}</td>
                  <td>{{ medicine.drugdetails.category }}</td>
                  <td><input class="form-control" style="width: 5rem ; height: 2rem; padding: 0.5rem;" type="number"
                      [ngModel]="medicine.quantity" (ngModelChange)="medicine.quantity = $event" min="0" /></td>
                  <td style="text-align: center;">
                    <div style="display: flex; align-items: center;">
                      <input class="form-control" style="width: 5rem; height: 2rem; padding: 0.5rem; margin-right: 6px;"
                        [ngModel]="medicine.price" (ngModelChange)="medicine.price = $event" type="number" min="1"
                        step="1" />
                      <span>EGP</span>
                    </div>
                  </td>
                </tr>
                }
              </tbody>
            </table>
          </div>
          }
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-success" (click)="onAddToStock()"
            data-bs-dismiss="modal">Confirm</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Request Admin Medicine Modal -->
  <div class="modal fade" id="requestAdminModal" tabindex="-1" aria-labelledby="requestAdminModalLabel">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="requestAdminModalLabel">Request To Add New Medicine</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <form (ngSubmit)="sendRequestToAdmin()" #requestForm="ngForm">
          <div class="modal-body">
            <div class="mb-3">
              <label for="commonName" class="form-label fw-semibold">Common Name</label>
              <input type="text" id="commonName" name="commonName" class="form-control"
                [(ngModel)]="requestData.commonName" required #commonName="ngModel"
                style="border-radius: 8px; font-size: 1rem; padding: 0.7rem;" />
            </div>
            <div *ngIf="(requestForm.submitted || commonName.touched) && commonName.invalid"
              class="text-danger small ms-2 mb-2">
              Please enter the medicine name.
            </div>
            <div class="mb-3">
              <label for="activeIngredient" class="form-label fw-semibold">Active Ingredient</label>
              <input type="text" id="activeIngredient" name="activeIngredient" class="form-control"
                [(ngModel)]="requestData.activeIngredient" required #activeIngredient="ngModel"
                style="border-radius: 8px; font-size: 1rem; padding: 0.7rem;" />
            </div>
            <div *ngIf="(requestForm.submitted || activeIngredient.touched) && activeIngredient.invalid"
              class="text-danger small ms-2 mb-2">
              Please enter the active ingredient.
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn submit-button" >Send Request</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>