<!-- Error Message -->
@if (displayedError) {
<div class="error-alert">
  <p>{{ displayedError }}</p>
</div>
}

<!-- Loading Spinner -->
@if (isLoading()) {
<div class="loading-container">
  <app-loading-spinner />
</div>
} @else {
<div class="container-fluid p-4 bg-light">
  <div class="row g-4">
    <!-- Cart Items Section -->
    <div class="col-md-8">
      <div class="card bg-white shadow-sm p-4 rounded-4">
        <h4 class="mb-4"><i class="bi bi-cart4 me-2"></i>Cart Items</h4>

        <div class="d-flex justify-content-end">
          <button class="btn btn-outline-danger btn-sm rounded-pill mb-3" style="width: 100%; max-width: 160px"
            (click)="clearCart()">
            <i class="bi bi-trash3-fill me-1"></i>Clear Cart
          </button>
        </div>

        @for(item of cartItems(); track item.drugId) {
        <app-cart-card [item]="item" (increment)="onIncrement(item)" (decrement)="onDecrement(item)"
          (remove)="removeItem(item)" class="mb-3"></app-cart-card>
        }

        @if(cartItems().length <= 0) { <div class="text-center text-muted mt-4">
          <i class="bi bi-bag-x-fill fs-1 mb-2 text-danger"></i>
          <p>Your cart is empty.</p>
      </div>
      }
    </div>
  </div>

  <!-- Summary Section -->
  <div class="col-md-4">
    <!-- Delivery Options -->
    <div class="card shadow-sm p-4 mb-3 rounded-4">
      <h6 class="fw-bold mb-3 text-dark">
        <i class="bi bi-truck me-1 text-primary"></i>Delivery Options
      </h6>
      <div class="form-check mb-2">
        <input class="form-check-input" type="radio" name="deliveryOption" value="home" checked />
        <label class="form-check-label">Home Delivery <small class="text-muted">2â€“4 hours</small></label>
      </div>
      <div class="form-check">
        <input class="form-check-input" type="radio" name="deliveryOption" value="pickup" />
        <label class="form-check-label">Pharmacy Pickup <small class="text-muted">30 mins</small></label>
      </div>
    </div>

    <!-- Address - Only show for authenticated users -->
    <div class="card shadow-sm p-4 mb-3 rounded-4" *ngIf="isAuthenticated()">
      <h6 class="fw-bold mb-3 text-dark">
        <i class="bi bi-geo-alt me-1 text-primary"></i>Delivery Address
      </h6>
      <ng-container *ngIf="orderSummary() as summary">
        <p class="mb-1">
          <i class="bi bi-house-door me-2"></i>{{ summary.address }}
        </p>
        <p class="mb-1">
          <i class="bi bi-globe me-2"></i>{{ summary.country }}
        </p>
        <p class="mb-1">
          <i class="bi bi-telephone me-2"></i>{{ summary.phoneNumber }}
        </p>
      </ng-container>
      <a href="#" class="text-decoration-underline text-primary mt-2 d-inline-block">
        <i class="bi bi-pencil-square me-1"></i>Change Address
      </a>
    </div>

    <!-- Order Summary -->
    <ng-container *ngIf="orderSummary() as summary">
      <div class="card shadow-sm p-4 mb-3 rounded-4" *ngIf="cartItems().length > 0">
        <h6 class="fw-bold mb-3 text-dark">
          <i class="bi bi-receipt me-1 text-primary"></i>Order Summary
        </h6>
        <div class="d-flex justify-content-between mb-1">
          <span>Subtotal:</span>
          <span>{{
            summary.subtotal.toFixed(2) | currency : "EGP" : "symbol"
            }}</span>
        </div>
        <div class="d-flex justify-content-between mb-1">
          <span>Delivery Fee:</span>
          <span>{{
            summary.deliveryFee.toFixed(2) | currency : "EGP" : "symbol"
            }}</span>
        </div>
        <hr />
        <div class="d-flex justify-content-between fw-bold fs-5">
          <span>Total:</span>
          <span>{{
            summary.total.toFixed(2) | currency : "EGP" : "symbol"
            }}</span>
        </div>
      </div>
    </ng-container>

    <!-- Payment Method -->
    <div class="card shadow-sm p-4 mb-3 rounded-4">
      <h6 class="fw-bold mb-3 text-dark">
        <i class="bi bi-credit-card-2-front me-1 text-primary"></i>Payment
        Method
      </h6>
      <div class="form-check mb-2">
        <input class="form-check-input" type="radio" name="paymentMethod" value="card" checked />
        <label class="form-check-label">Credit/Debit Card</label>
      </div>
      <div class="form-check">
        <input class="form-check-input" type="radio" name="paymentMethod" value="cash" />
        <label class="form-check-label">Cash on Delivery</label>
      </div>
    </div>

    <!-- Checkout Button -->
    <button class="btn btn-primary w-100 py-3 fs-5 rounded-3 shadow-sm" (click)="checkout()">
      <i class="bi bi-check-circle me-2" *ngIf="isAuthenticated()"></i>
      <i class="bi bi-box-arrow-in-right me-2" *ngIf="!isAuthenticated()"></i>
      Proceed to Checkout
    </button>
  </div>
</div>
</div>

<!-- Empty Cart Modal -->
<div class="modal fade" id="emptyCartModal" tabindex="-1" aria-labelledby="emptyCartModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow-lg rounded-4">
      <div class="modal-header border-0 bg-light rounded-top-4 px-4 pt-4">
        <h5 class="modal-title d-flex align-items-center" id="emptyCartModalLabel">
          <i class="bi bi-exclamation-circle-fill text-warning fs-3 me-2"></i>
          Your Cart is Empty
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body text-center px-4 pb-0">
        <p class="fs-6 text-muted mb-3">
          There are no items to clear from your cart.
        </p>
        <i class="bi bi-cart-x-fill text-danger fs-1 mb-3"></i>
      </div>

      <div class="modal-footer border-0 justify-content-center pb-4">
        <button type="button" class="btn btn-secondary rounded-pill px-4 py-2" data-bs-dismiss="modal">
          <i class="bi bi-arrow-left me-1"></i>Back to Cart
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Min Order Modal -->
<div class="modal fade" id="minOrderModal" tabindex="-1" aria-labelledby="minOrderModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow-lg rounded-4">
      <div class="modal-header border-0 bg-light rounded-top-4 px-4 pt-4">
        <h5 class="modal-title d-flex align-items-center" id="minOrderModalLabel">
          <i class="bi bi-exclamation-circle-fill text-warning fs-3 me-2"></i>
          Minimum Order Not Met
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body text-center px-4 pb-0">
        <p class="fs-6 text-muted mb-3">
          Sorry, the minimum order total must be at least
          <strong>30 EGP</strong> to proceed to checkout.
        </p>
        <i class="bi bi-cash-coin text-danger fs-1 mb-3"></i>
      </div>

      <div class="modal-footer border-0 justify-content-center pb-4">
        <button type="button" class="btn btn-secondary rounded-pill px-4 py-2" data-bs-dismiss="modal">
          <i class="bi bi-arrow-left me-1"></i>Back to Cart
        </button>
      </div>
    </div>
  </div>
</div>
}

<div class="modal fade" id="stockLimitModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content shadow-lg rounded-4 border-0">
      <div class="modal-header bg-light border-0">
        <div class="d-flex align-items-center">
          <i class="bi bi-exclamation-circle-fill text-warning-custom fs-3 me-2"></i>
          <h5 class="modal-title fw-semibold text-dark m-0">Stock Limit Reached</h5>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body text-secondary fs-6">
        {{ cartStore.modalMessage }}
      </div>
      <div class="modal-footer border-0">
        <button type="button" class="btn  bg-warning-custom rounded-pill px-4" data-bs-dismiss="modal">
          OK
        </button>
      </div>
    </div>
  </div>
</div>
