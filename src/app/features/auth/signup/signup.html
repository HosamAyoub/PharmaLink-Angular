<div class="signup-container">
  <div class="signup-card">
    <!-- Logo Section -->
    <div class="logo-section">
      <a routerLink="/client/home">
        <img
          src="assets/images/logos/logo.png"
          alt="PharmaLink Logo"
          class="logo"
          style="width: 80px; height: 80px"
        />
      </a>
    </div>

    <!-- Title & Subtitle -->
    <h1 class="signup-title">Create Account</h1>
    <p class="signup-subtitle">
      Join PharmaLink for better medicine management
    </p>

    <!-- Stepper -->
    <div class="stepper">
      <div class="step" [class.active]="step === 1">
        <span>1</span>
        <span class="step-label">Account Info</span>
      </div>
      <div class="step-separator"></div>
      <div class="step" [class.active]="step === 2">
        <span>2</span>
        <span class="step-label">Medical Info</span>
      </div>
    </div>

    <!-- Error Message -->
    @if (displayedError) {
    <div class="error-alert">
      <p>{{ displayedError }}</p>
    </div>
    }

    <!-- Loading Spinner -->
    @if (isLoading()) {
    <div class="loading-container">
      <app-loading-spinner />
    </div>
    } @else {

    <!-- Signup Form with Stepper Logic -->
    <form #signupForm="ngForm" class="signup-form" autocomplete="off">
      <!-- Step 1: Account Info -->
      @if (step === 1) {
      <div class="step-content">
        <div class="form-row">
          <div class="form-group">
            <label for="name" class="form-label required">Full Name</label>
            <input
              type="text"
              id="name"
              name="name"
              class="form-input"
              [(ngModel)]="formModel.name"
              required
              placeholder="Enter your full name"
              (input)="clearError()"
              #nameField="ngModel"
              [class.invalid]="isNameInvalid(nameField)"
            />
            @if (isNameInvalid(nameField)) {
            <div class="field-error">
              {{ getNameErrorMessage(nameField) }}
            </div>
            }
          </div>
          <div class="form-group">
            <label for="userName" class="form-label required">User Name</label>
            <input
              type="text"
              id="userName"
              name="userName"
              class="form-input"
              [(ngModel)]="formModel.userName"
              required
              placeholder="Enter a user name"
              (input)="clearError()"
              #userNameField="ngModel"
              [class.invalid]="getUserNameInvalid(userNameField)"
              [class]="getUsernameCssClass()"
            />
            @if (getUserNameInvalid(userNameField)) {
            <div class="field-error">
              {{ getUserNameErrorMessage(userNameField) }}
            </div>
            }
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="password" class="form-label required">Password</label>
            <input
              type="password"
              id="password"
              name="password"
              class="form-input"
              [(ngModel)]="formModel.passwordHash"
              required
              minlength="6"
              placeholder="Create a password"
              (input)="clearError()"
              #passwordField="ngModel"
              [class.invalid]="isPasswordInvalid(passwordField)"
              [class]="getPasswordCssClass()"
            />
            @if (isPasswordInvalid(passwordField)) {
            <div class="field-error">
              {{ getPasswordErrorMessage(passwordField) }}
            </div>
            }

            <!-- Password Requirements -->
            @if (isPasswordInvalid(passwordField)) {
            <div class="password-requirements">
              <h4>Password Requirements:</h4>
              <div
                class="requirement"
                [class.met]="
                  getPasswordRequirements(formModel.passwordHash).minLength
                "
                [class.not-met]="
                  !getPasswordRequirements(formModel.passwordHash).minLength
                "
              >
                At least 6 characters
              </div>
              <div
                class="requirement"
                [class.met]="
                  getPasswordRequirements(formModel.passwordHash).hasLower
                "
                [class.not-met]="
                  !getPasswordRequirements(formModel.passwordHash).hasLower
                "
              >
                Lowercase letter (a-z)
              </div>
              <div
                class="requirement"
                [class.met]="
                  getPasswordRequirements(formModel.passwordHash).hasUpper
                "
                [class.not-met]="
                  !getPasswordRequirements(formModel.passwordHash).hasUpper
                "
              >
                Uppercase letter (A-Z)
              </div>
              <div
                class="requirement"
                [class.met]="
                  getPasswordRequirements(formModel.passwordHash).hasNumber
                "
                [class.not-met]="
                  !getPasswordRequirements(formModel.passwordHash).hasNumber
                "
              >
                Number (0-9)
              </div>
              <div
                class="requirement"
                [class.met]="
                  getPasswordRequirements(formModel.passwordHash).hasSymbol
                "
                [class.not-met]="
                  !getPasswordRequirements(formModel.passwordHash).hasSymbol
                "
              >
                Special character (!&#64;#$%^&*...)
              </div>
            </div>
            }
          </div>
          <div class="form-group">
            <label for="confirmPassword" class="form-label required"
              >Confirm Password</label
            >
            <input
              type="password"
              id="confirmPassword"
              name="confirmPassword"
              class="form-input"
              [(ngModel)]="formModel.confirmPassword"
              required
              minlength="6"
              placeholder="Confirm your password"
              (input)="clearError()"
              #confirmPasswordField="ngModel"
              [class.invalid]="isConfirmPasswordInvalid(confirmPasswordField)"
              [class]="getConfirmPasswordCssClass()"
            />
            @if (isConfirmPasswordInvalid(confirmPasswordField)) {
            <div class="field-error">
              {{ getConfirmPasswordErrorMessage(confirmPasswordField) }}
            </div>
            }
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="email" class="form-label required">Email</label>
            <input
              type="email"
              id="email"
              name="email"
              class="form-input"
              [(ngModel)]="formModel.email"
              required
              email
              placeholder="Enter your email"
              (input)="clearError()"
              #emailField="ngModel"
              [class.invalid]="isEmailInvalid(emailField)"
            />
            @if (isEmailInvalid(emailField)) {
            <div class="field-error">
              {{ getEmailErrorMessage(emailField) }}
            </div>
            }
          </div>
          <div class="form-group">
            <label for="phoneNumber" class="form-label required"
              >Mobile Number</label
            >
            <input
              type="tel"
              id="phoneNumber"
              name="phoneNumber"
              class="form-input"
              [(ngModel)]="formModel.phoneNumber"
              required
              placeholder="Enter your mobile number"
              (input)="clearError()"
              #phoneField="ngModel"
              [class.invalid]="isPhoneInvalid(phoneField)"
            />
            @if (isPhoneInvalid(phoneField)) {
            <div class="field-error">
              {{ getPhoneErrorMessage(phoneField) }}
            </div>
            }
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="gender" class="form-label required">Gender</label>
            <select
              id="gender"
              name="gender"
              class="form-input"
              [(ngModel)]="formModel.gender"
              required
              #genderField="ngModel"
              [class.invalid]="isGenderInvalid(genderField)"
            >
              <option value="" disabled selected>Select gender</option>
              <option value="0">Male</option>
              <option value="1">Female</option>
            </select>
            @if (isGenderInvalid(genderField)) {
            <div class="field-error">
              {{ getGenderErrorMessage(genderField) }}
            </div>
            }
          </div>
          <div class="form-group">
            <label for="dateOfBirth" class="form-label required"
              >Date of Birth</label
            >
            <input
              type="date"
              id="dateOfBirth"
              name="dateOfBirth"
              class="form-input"
              [(ngModel)]="formModel.dateOfBirth"
              required
              placeholder="dd/mm/yyyy"
              #dateField="ngModel"
              [class.invalid]="isDateOfBirthInvalid(dateField)"
            />
            @if (isDateOfBirthInvalid(dateField)) {
            <div class="field-error">
              {{ getDateOfBirthErrorMessage(dateField) }}
            </div>
            }
          </div>
          <div class="form-group">
            <label for="country" class="form-label required">Country</label>
            <select
              id="country"
              name="country"
              class="form-input"
              [(ngModel)]="formModel.country"
              required
              #countryField="ngModel"
              [class.invalid]="isCountryInvalid(countryField)"
            >
              <option value="" disabled selected>Select country</option>
              <option value="egypt">Egypt</option>
              <option value="ksa">KSA</option>
              <option value="uae">UAE</option>
              <option value="other">Other</option>
            </select>
            @if (isCountryInvalid(countryField)) {
            <div class="field-error">
              {{ getCountryErrorMessage(countryField) }}
            </div>
            }
          </div>
        </div>
        <div class="form-group">
          <label for="address" class="form-label optional">Address</label>
          <input
            type="text"
            id="address"
            name="address"
            class="form-input"
            [(ngModel)]="formModel.address"
            placeholder="Enter your full address (optional)"
          />
        </div>
        <button
          type="button"
          class="signup-btn"
          [disabled]="!signupForm.valid"
          (click)="step = 2"
        >
          Next Step
        </button>
      </div>
      }
      <!-- Step 2: Medical Info -->
      @else if (step === 2) {
      <div class="step-content">
        <div class="form-group">
          <label for="patientDiseases" class="form-label optional"
            >Patient Diseases</label
          >
          <textarea
            id="patientDiseases"
            name="patientDiseases"
            class="form-input"
            [(ngModel)]="formModel.patientDiseases"
            placeholder="List any diseases (optional)"
            rows="4"
          ></textarea>
        </div>
        <div class="form-group">
          <label for="patientDrugs" class="form-label optional"
            >Patient Drugs</label
          >
          <textarea
            id="patientDrugs"
            name="patientDrugs"
            class="form-input"
            [(ngModel)]="formModel.patientDrugs"
            placeholder="List any drugs (optional)"
            rows="4"
          ></textarea>
        </div>
        <div class="note">
          <b>Privacy Note:</b> Your medical information is encrypted and stored
          securely. It will only be used to provide better healthcare
          recommendations and will never be shared without your explicit
          consent.
        </div>
        <div class="button-group">
          <button type="button" class="signup-btn secondary" (click)="step = 1">
            Back
          </button>
          <button
            type="submit"
            class="signup-btn"
            [disabled]="!signupForm.valid || isLoading()"
            (click)="onSubmit(signupForm)"
          >
            {{ isLoading() ? "Creating Account..." : "Create Account" }}
          </button>
        </div>
      </div>
      }
    </form>
    }
    <div class="signin-link">
      Already have an account? <a routerLink="/login">Sign in</a>
    </div>
  </div>
</div>
